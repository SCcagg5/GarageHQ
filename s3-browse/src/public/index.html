<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link id="favicon" rel="shortcut icon" />
  <title>Bucket Browser</title>

  <!-- Vendors CSS -->
  <link rel="stylesheet" href="assets/vendor/mdi/7.4.47/css/materialdesignicons.min.css" />
  <link rel="stylesheet" href="assets/vendor/buefy/1.0.1/buefy.min.css" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <!-- UI partagé -->
  <link rel="stylesheet" href="assets/css/ui.css" />
</head>
<body>
  <div id="root">
    <div id="app">
      <div :style="cssVars">

        <!-- Ligne 1 : icône + / <prefix> -->
        <div class="top">
          <div class="container">
            <div class="head">
              <div class="title" style="display:flex;align-items:center;gap:.5rem;">
                <i class="mdi mdi-database-outline" style="font-size:1.3rem;"></i>
                <h1 style="margin:0;font-size:1.15rem;font-weight:600;">
                  / {{ (pathPrefix || '').replace(/\/$/, '') }}
                </h1>
              </div>
              <div class="right"><!-- nothing --></div>
            </div>
          </div>
        </div>

        <!-- Ligne 2 : search à gauche, actions à droite -->
        <div class="toolbar">
          <div class="container" style="display:flex;align-items:center;gap:1rem;">
            <!-- Gauche : search -->
            <div class="toolbar-left" style="flex:1 1 auto;min-width:280px;">
              <b-field>
                <b-input
                  expanded
                  v-model="searchPrefix"
                  placeholder="Search current folder (prefix)..."
                  @keyup.native.enter="searchByPrefix">
                </b-input>
                <p class="control">
                  <b-button
                    type="is-primary"
                    rounded
                    icon-pack="mdi"
                    icon-left="mdi-magnify"
                    @click="searchByPrefix">
                    Search
                  </b-button>
                </p>
              </b-field>
            </div>

            <div class="toolbar-spacer" style="flex:0 0 12px;"></div>

            <!-- Droite : Refresh, Actions, New -->
            <div class="toolbar-right" style="display:flex;align-items:center;gap:.5rem;">
              <b-button type="is-light" rounded icon-pack="mdi" icon-left="mdi-refresh" @click="manualRefresh">
                Refresh
              </b-button>

              <b-dropdown position="is-bottom-left" :mobile-modal="false" append-to-body aria-role="menu">
                <template #trigger="{ active }">
                  <b-button type="is-light" rounded icon-pack="mdi" icon-left="mdi-cog">
                    Actions
                    <i class="mdi mdi-chevron-down" style="margin-left:.35rem;"></i>
                  </b-button>
                </template>
                <b-dropdown-item
                  :disabled="!canDownloadAll"
                  @click="canDownloadAll && downloadAllFiles()">
                  <i class="mdi mdi-archive-arrow-down-outline"></i>
                  <span style="margin-left:.5rem;">Download all files</span>
                </b-dropdown-item>
                <b-dropdown-item @click="onCurrentFolderDetails">
                  <i class="mdi mdi-information-outline"></i>
                  <span style="margin-left:.5rem;">Détails du dossier</span>
                  </b-dropdown-item>
              </b-dropdown>

              <b-dropdown position="is-bottom-left" :mobile-modal="false" append-to-body aria-role="menu">
                <template #trigger="{ active }">
                  <b-button type="is-primary" rounded icon-pack="mdi" icon-left="mdi-plus">
                    New
                    <i class="mdi mdi-chevron-down" style="margin-left:.35rem;"></i>
                  </b-button>
                </template>
                <b-dropdown-item @click="triggerUpload">
                  <i class="mdi mdi-file-upload-outline"></i>
                  <span style="margin-left:.5rem;">Upload file</span>
                </b-dropdown-item>
                <b-dropdown-item @click="triggerUploadDir">
                  <i class="mdi mdi-folder-upload"></i>
                  <span style="margin-left:.5rem;">Upload folder</span>
                </b-dropdown-item>
              </b-dropdown>
            </div>
          </div>
        </div>

        <!-- Inputs upload cachés -->
        <input type="file" ref="fileInput" style="display:none" @change="onFileInput">
        <input type="file" ref="dirInput" style="display:none" webkitdirectory @change="onDirInput">

        <!-- Tableau -->
        <div class="container">
          <div class="card">

            <!-- Barre pagination (AU-DESSUS de l'entête du tableau) -->
            <div class="card-content" style="padding-bottom:0;">
              <nav class="level is-mobile" style="margin-bottom:.5rem;">
                <div class="level-left" style="flex-wrap:wrap;gap:.5rem;">
                  <div class="level-item">
                    <span class="has-text-grey">Page&nbsp;<strong>{{ currentPage }}</strong></span>
                  </div>
                  <div class="level-item">
                    <span class="has-text-grey">Éléments / page</span>
                  </div>
                  <div class="level-item">
                    <b-select v-model="pageSize" size="is-small" :disabled="isRefreshing">
                      <option :value="5">5</option>
                      <option :value="50">50</option>
                      <option :value="100">100</option>
                      <option :value="500">500</option>
                    </b-select>
                  </div>
                </div>

                <div class="level-right" style="flex-wrap:wrap;gap:.5rem;">
                  <div class="level-item">
                    <b-button size="is-small" type="is-light" icon-pack="mdi" icon-left="mdi-chevron-left"
                              :disabled="previousContinuationTokens.length === 0"
                              title="Page précédente"
                              @click="previousPage">
                      Précédent
                    </b-button>
                  </div>
                  <div class="level-item">
                    <b-button size="is-small" type="is-light" icon-pack="mdi" icon-right="mdi-chevron-right"
                              :disabled="!nextContinuationToken"
                              title="Page suivante"
                              @click="nextPage">
                      Suivant
                    </b-button>
                  </div>
                </div>
              </nav>
            </div>

            <div class="card-content">
              <div class="table-wrap">
                <b-table
                  :data="pathContentTableData"
                  :hoverable="true"
                  :striped="false"
                  :loading="isRefreshing"
                  :mobile-cards="true"
                  :sortable="false">

                  <!-- Colonne Nom (icône + span cliquable) -->
                  <b-table-column v-slot="props" field="name" label="Name" cell-class="name-column">
                    <!-- Fichier -->
                    <div v-if="props.row.type === 'content'" style="display:flex;align-items:center;gap:.5rem;">
                      <b-icon pack="mdi" :icon="fileRowIcon(props.row)" class="name-column-icon is-smmd"></b-icon>
                      <span class="clickable" :title="props.row.name" @click="openPreview(props.row)">{{ props.row.name }}</span>
                    </div>
                    <!-- Dossier -->
                    <div v-else style="display:flex;align-items:center;gap:.5rem;">
                      <b-icon pack="mdi" :icon="'folder'" class="name-column-icon is-smmd"></b-icon>
                      <span class="clickable" :title="props.row.name" @click="goToPrefix(props.row.prefix)">{{ props.row.name }}</span>
                    </div>
                  </b-table-column>

                  <!-- Colonne Taille -->
                  <b-table-column v-slot="props" field="size" label="Size" width="140">
                    <span v-if="props.row.type === 'content'">{{ formatBytes(props.row.size) }}</span>
                    <span v-else>—</span>
                  </b-table-column>

                  <!-- Colonne Date (relative + hover UTC) -->
                  <b-table-column v-slot="props" field="dateModified" label="Last Modified" width="220">
                    <span v-if="props.row.dateModified"
                          :title="formatDateTime_utc(props.row.dateModified)">
                      {{ formatDateTime_relative(props.row.dateModified) }}
                    </span>
                    <span v-else>—</span>
                  </b-table-column>

                  <!-- Colonne Actions (kebab à droite) -->
                <b-table-column v-slot="props" field="__actions" label="" width="72" cell-class="is-right" header-class="is-right">
                  <div style="display:flex;justify-content:flex-end;">
                      <div v-if="props.row.type === 'content'" class="bb-menu" :data-key="props.row.key">
                        <span class="bb-kebab" aria-haspopup="menu" aria-expanded="false" title="Options">
                          <i class="mdi mdi-dots-vertical"></i>
                        </span>
                        <div class="bb-menu-popover">
                          <div class="bb-menu-list">
                            <div class="bb-menu-item" @click="onRowDownload(props.row)"><i class="mdi mdi-download"></i> Télécharger</div>
                            <div class="bb-menu-item" @click="onRowRename(props.row)"><i class="mdi mdi-rename-outline"></i> Renommer</div>
                            <div class="bb-menu-item" @click="onRowDetails(props.row)"><i class="mdi mdi-information-outline"></i> Détails</div>
                            <div class="bb-menu-item danger" @click="onRowDelete(props.row)"><i class="mdi mdi-delete-outline"></i> Supprimer</div>
                          </div>
                        </div>
                      </div>
                      <div v-else class="bb-menu" :data-prefix="props.row.prefix">
                        <span class="bb-kebab" aria-haspopup="menu" aria-expanded="false" title="Options">
                          <i class="mdi mdi-dots-vertical"></i>
                        </span>
                        <div class="bb-menu-popover">
                          <div class="bb-menu-list">
                            <div class="bb-menu-item" @click="onPrefixDetails(props.row)"><i class="mdi mdi-information-outline"></i> Détails</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </b-table-column>

                </b-table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Vendors -->
  <script src="assets/vendor/vue/3.5.18/vue.global.prod.js"></script>
  <script>window.process = {env: {NODE_ENV: 'production'}};</script>
  <script src="assets/vendor/buefy/1.0.1/buefy.min.js"></script>
  <script src="assets/vendor/moment/2.30.1/moment.min.js"></script>
  <script src="assets/vendor/fflate/0.8.2/index.min.js"></script>

  <!-- Shared (ordre important) -->
  <script src="assets/js/common/detect.js"></script>
  <script src="assets/js/common/api.js"></script>
  <script src="assets/js/common/ui.js"></script>
  <script src="assets/js/common/actions.js"></script>
  <script src="assets/js/common/menu.js"></script>

  <!-- App -->
  <script src="assets/js/app.js"></script>
</body>
</html>
