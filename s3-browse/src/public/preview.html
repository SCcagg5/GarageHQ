<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Preview</title>

  <!-- Icons + Markdown skin + Highlight theme -->
  <link rel="stylesheet" href="assets/vendor/mdi/7.4.47/css/materialdesignicons.min.css" />
  <link rel="stylesheet" href="assets/vendor/github-markdown-css/5/github-markdown-light.min.css" />
  <link rel="stylesheet" href="assets/vendor/highlightjs/11/styles/github.min.css" />

  <style>
    :root {
      --primary: #167df0;
      --wrap-max: 1012px;
      --h-pad: 2.5rem;
      --v-pad: 4.5rem;
    }
    html, body { height: 100%; background: whitesmoke; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
      color: #1f2d3d;
    }
    .bar {
      display: flex; align-items: center; justify-content: space-between; gap: .75rem;
      padding: .75rem max(calc(100% - var(--wrap-max)), var(--h-pad));
      background: #fff; border-bottom: 1px solid #e8e8e8;
      position: sticky; top: 0; z-index: 10;
    }
    .bar-left { min-width: 0; display: flex; align-items: center; gap: .5rem; }
    .doc-name {
      font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: min(50vw, 520px);
    }
    .doc-size { color: #6b7280; font-size: .95em; white-space: nowrap; }
    .bar-right { display: flex; align-items: center; gap: .25rem; }
    .icon-btn {
      display: inline-flex; align-items: center; justify-content: center;
      width: 34px; height: 34px; border-radius: 8px; cursor: pointer;
      color: #64748b; text-decoration: none;
    }
    .icon-btn:hover { background: #eef5ff; color: var(--primary); }
    .icon-btn[aria-disabled="true"] { opacity: .45; pointer-events: none; }
    .menu { position: relative; }
    .menu-pop {
      position: absolute; left: 0; top: 100%; margin-top: 6px; min-width: 180px;
      background: #fff; border: 1px solid #e5e7eb; border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08); padding: .35rem; display: none;
    }
    .menu[data-open="1"] .menu-pop { display: block; }
    .menu-item {
      padding: .5rem .6rem; border-radius: 8px; font-size: .95rem; color: #111827;
      display: flex; align-items: center; gap: .5rem; cursor: pointer; white-space: nowrap;
    }
    .menu-item:hover { background: #f3f4f6; color: #111827; }
    .menu-item.danger { color: #b91c1c; }
    .menu-item.danger:hover { background: #fee2e2; }
    .viewer {
      padding: var(--v-pad) max(calc(100% - max(var(--wrap-max), min(var(--wrap-max), 100%))) / 2, var(--h-pad));
      min-height: calc(100vh - (2 * var(--v-pad)));
    }
    .markdown-body img, .markdown-body video {
      display: block; max-width: 100%; height: auto; margin: 1rem auto;
    }
    .markdown-body iframe, .markdown-body embed {
      display: block; width: 100%; height: calc(100vh - 6rem);
      border: 0; background: #fff; border-radius: 8px;
    }
    pre { border-radius: 10px; overflow: auto; padding: 1rem; background: #f6f8fa; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size: .95rem; line-height: 1.55; }
  </style>
</head>
<body>
  <div class="bar">
    <div class="bar-left">
      <!-- Bouton retour (ajouté) -->
      <a class="icon-btn" id="backBtn" title="Retour"><i class="mdi mdi-arrow-left"></i></a>

      <span class="doc-name" id="docName"></span>
      <span class="doc-size" id="docSize"></span>
    </div>
    <div class="bar-right">
      <a class="icon-btn" id="downloadBtn" title="Télécharger"><i class="mdi mdi-download"></i></a>

      <div class="menu" id="gearMenu">
        <span class="icon-btn" id="gearBtn" title="Actions"><i class="mdi mdi-dots-vertical"></i></span>
        <div class="menu-pop" id="gearPop">
          <div class="menu-item" id="metaBtn"><i class="mdi mdi-information-outline"></i> Métadonnées</div>
          <div class="menu-item" id="renameBtn"><i class="mdi mdi-rename-outline"></i> Renommer</div>
          <div class="menu-item" id="copyUrlBtn"><i class="mdi mdi-link-variant"></i> Copier l’URL</div>
          <div class="menu-item danger" id="deleteBtn"><i class="mdi mdi-delete-outline"></i> Supprimer</div>
        </div>
      </div>
    </div>
  </div>

  <main id="viewer" class="viewer markdown-body"></main>

  <!-- libs -->
  <script src="assets/vendor/highlightjs/11/highlight.min.js"></script>
  <script src="assets/vendor/marked/12.0.2/marked.min.js"></script>

  <script>
    const CONFIG = { bucketUrl: '/s3', bucketMaskUrl: '/s3', rootPrefix: '', trashPrefix: '_trash/' };

    function encodePath(path) {
      path = (path || '').replace(/\/{2,}/g, '/');
      try { if (decodeURI(path) !== path) return path; } catch(e) {}
      const m = {";":"%3B","?":"%3F",":":"%3A","@":"%40","&":"%26","=":"%3D","+":"%2B","$":"%24",",":"%2C","#":"%23"};
      return encodeURI(path).split("").map(ch => m[ch] || ch).join("");
    }
    function extOf(s='') { const m = /\.([^.]+)$/.exec((s||'').toLowerCase()); return m ? m[1] : ''; }
    function formatBytes(size) {
      const KB=1024, MB=1048576, GB=1073741824;
      if (size == null || isNaN(size)) return '';
      if (size<KB) return size+' B';
      if (size<MB) return (size/KB).toFixed(0)+' KB';
      if (size<GB) return (size/MB).toFixed(2)+' MB';
      return (size/GB).toFixed(2)+' GB';
    }
    const EXT_TO_LANG = {
      sh:'bash', bash:'bash', zsh:'bash', ksh:'bash', fish:'bash',
      ps1:'powershell', js:'javascript', mjs:'javascript', cjs:'javascript',
      ts:'typescript', jsx:'jsx', tsx:'tsx',
      json:'json', yaml:'yaml', yml:'yaml', toml:'toml',
      html:'xml', htm:'xml', xhtml:'xml', vue:'xml', svelte:'xml',
      css:'css', scss:'scss', less:'less', md:'markdown',
      xml:'xml', svg:'xml',
      ini:'ini', cfg:'ini', properties:'ini', env:'ini',
      sql:'sql', gql:'graphql', graphql:'graphql',
      dockerfile:'dockerfile', makefile:'makefile', nginx:'nginx',
      java:'java', kt:'kotlin', go:'go', rs:'rust', py:'python',
      rb:'ruby', php:'php', pl:'perl', lua:'lua', swift:'swift',
      c:'c', h:'c', cpp:'cpp', cc:'cpp', cxx:'cpp', hpp:'cpp'
    };

    function parseHash() {
      const raw = decodeURIComponent(location.hash || '').replace(/^#/, '');
      const q = raw.indexOf('?');
      const path = q === -1 ? raw : raw.slice(0, q);
      const qs = new URLSearchParams(q === -1 ? '' : raw.slice(q));
      return { path, qs };
    }

    const viewer = document.getElementById('viewer');
    const docNameEl = document.getElementById('docName');
    const docSizeEl = document.getElementById('docSize');
    const downloadBtn = document.getElementById('downloadBtn');
    const backBtn = document.getElementById('backBtn');
    const gearMenu = document.getElementById('gearMenu');
    const gearBtn = document.getElementById('gearBtn');
    const gearPop = document.getElementById('gearPop');
    const metaBtn = document.getElementById('metaBtn');
    const renameBtn = document.getElementById('renameBtn');
    const copyUrlBtn = document.getElementById('copyUrlBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    if (backBtn) backBtn.addEventListener('click', () => history.back());

    function closeMenus(e) { if (!gearMenu.contains(e.target)) gearMenu.dataset.open = '0'; }
    gearBtn.addEventListener('click', () => { gearMenu.dataset.open = gearMenu.dataset.open === '1' ? '0' : '1'; });
    document.addEventListener('click', closeMenus);

    async function render() {
      const { path, qs } = parseHash();
      const name = (path.split('/').pop() || path || 'preview');
      document.title = `${name} — Bucket Browser`;
      docNameEl.textContent = name;

      const base = (CONFIG.bucketMaskUrl || CONFIG.bucketUrl).replace(/\/*$/, '');
      const fileUrl = `${base}/${encodePath(path)}`;
      downloadBtn.href = fileUrl;
      downloadBtn.setAttribute('download', name);

      let contentType = '', contentLength = '';
      try {
        const head = await fetch(fileUrl, { method: 'HEAD' });
        if (head.ok) {
          contentType = head.headers.get('Content-Type') || '';
          contentLength = head.headers.get('Content-Length') || '';
        }
      } catch {}
      docSizeEl.textContent = contentLength ? `• ${formatBytes(parseInt(contentLength,10))}` : '';

      let type = qs.get('type');
      let lang = qs.get('lang');

      if (!type) {
        const e = extOf(name);
        if (e === 'md') type = 'markdown';
        else if ((contentType||'').startsWith('image/')) type = 'image';
        else if (contentType === 'application/pdf' || e === 'pdf') type = 'pdf';
        else if ((contentType||'').startsWith('text/') || EXT_TO_LANG[e]) type = 'code';
        else type = 'download';
      }
      if (type === 'code' && !lang) lang = EXT_TO_LANG[extOf(name)] || '';

      viewer.innerHTML = '';
      if (type === 'image') {
        const img = document.createElement('img'); img.src = fileUrl; img.alt = name; viewer.appendChild(img); return;
      }
      if (type === 'pdf') {
        const iframe = document.createElement('iframe'); iframe.src = fileUrl; viewer.appendChild(iframe); return;
      }
      if (type === 'download') {
        const p = document.createElement('p'); p.textContent = 'Ce type de fichier ne peut pas être prévisualisé. Téléchargez-le.'; viewer.appendChild(p); return;
      }

      let text;
      try {
        const resp = await fetch(fileUrl);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        text = await resp.text();
      } catch (e) {
        viewer.innerHTML = `<pre><code>Erreur de chargement: ${String(e)}</code></pre>`;
        return;
      }

      if (type === 'markdown') {
        if (!window.marked) { viewer.innerHTML = `<pre><code>Erreur: moteur Markdown manquant.</code></pre>`; return; }
        if (window.marked && typeof marked.setOptions === 'function') {
          marked.setOptions({ gfm: true, breaks: true });
        }
        const html = marked.parse(text);
        const art = document.createElement('article');
        art.className = 'markdown-body';
        art.innerHTML = html;
        viewer.appendChild(art);
        if (window.hljs && typeof hljs.highlightElement === 'function') {
          art.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
        }
        return;
      }

      // code
      const pre = document.createElement('pre');
      const code = document.createElement('code');
      code.textContent = text;

      if (window.hljs) {
        try {
          if (lang && typeof hljs.getLanguage === 'function' && hljs.getLanguage(lang)) {
            code.className = `language-${lang}`;
            pre.appendChild(code); viewer.appendChild(pre);
            hljs.highlightElement(code);
          } else if (typeof hljs.highlightAuto === 'function') {
            const res = hljs.highlightAuto(text);
            code.className = `language-${res.language || 'plaintext'}`;
            pre.appendChild(code); viewer.appendChild(pre);
            hljs.highlightElement(code);
          } else {
            pre.appendChild(code); viewer.appendChild(pre);
          }
        } catch {
          pre.appendChild(code); viewer.appendChild(pre);
        }
      } else {
        pre.appendChild(code); viewer.appendChild(pre);
      }
    }

    function currentKey() { return parseHash().path; }
    function bucketURLForKey(k) { return `${(CONFIG.bucketUrl || '/s3').replace(/\/*$/, '')}/${encodePath(k)}`; }

    document.getElementById('metaBtn').addEventListener('click', async () => {
      try {
        const url = bucketURLForKey(currentKey());
        const res = await fetch(url, { method: 'HEAD' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const meta = {}; res.headers.forEach((v,k)=> meta[k]=v);
        alert(`Metadata — ${decodeURIComponent(currentKey().split('/').pop()||'')}\n\n` + JSON.stringify(meta, null, 2));
      } catch (e) { alert('Erreur métadonnées: ' + e); }
    });

    document.getElementById('renameBtn').addEventListener('click', async () => {
      const oldKey = currentKey();
      const baseName = decodeURIComponent(oldKey.split('/').pop() || '');
      const newName = prompt('Nouveau nom du fichier', baseName);
      if (!newName || newName === baseName) return;

      const parent = oldKey.replace(/[^/]*$/, '');
      const newKey = parent + newName;

      try {
        const get = await fetch(bucketURLForKey(oldKey));
        if (!get.ok) throw new Error(`GET ${get.status}`);
        const blob = await get.blob();
        const put = await fetch(bucketURLForKey(newKey), {
          method: 'PUT', headers: { 'Content-Type': blob.type || 'application/octet-stream' }, body: blob
        });
        if (!put.ok) throw new Error(`PUT ${put.status}`);
        const del = await fetch(bucketURLForKey(oldKey), { method: 'DELETE' });
        // si 405, on ignore (proxy ne permet pas DELETE)
        const url = new URL(location.href);
        const hash = decodeURIComponent(url.hash).replace(/^#/, '');
        const qPos = hash.indexOf('?');
        const qs = qPos === -1 ? '' : hash.slice(qPos);
        location.replace('#' + encodeURIComponent(newKey).replace(/%2F/g,'/') + qs);
        render();
      } catch (e) { alert('Erreur renommage: ' + e); }
    });

    document.getElementById('copyUrlBtn').addEventListener('click', async () => {
      const base = (CONFIG.bucketMaskUrl || CONFIG.bucketUrl).replace(/\/*$/, '');
      const url = `${base}/${encodePath(currentKey())}`;
      try { await navigator.clipboard.writeText(url); gearMenu.dataset.open = '0'; }
      catch { prompt('Copiez l’URL :', url); }
    });

    document.getElementById('deleteBtn').addEventListener('click', async () => {
      const key = currentKey();
      if (!confirm(`Supprimer “${decodeURIComponent(key.split('/').pop() || '')}” ?`)) return;
      try {
        const res = await fetch(bucketURLForKey(key), { method: 'DELETE' });
        if (!res.ok) { alert('Suppression non autorisée par le proxy (DELETE 405).'); return; }
        alert('Supprimé.'); history.back();
      } catch (e) { alert('Erreur suppression: ' + e); }
    });

    window.addEventListener('hashchange', render);
    render();
  </script>
</body>
</html>
